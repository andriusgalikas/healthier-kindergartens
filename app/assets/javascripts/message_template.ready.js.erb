var Messages = {

  initList: function() {
    this.initListFilters();
    this.initRoleSelector();
    this.initSubjectSelector();
    this.initPrinter();

    $('.datepicker').datetimepicker({
      format: 'd/m/Y',
      timepicker: false
    });

    $('.truncate').shorten({
      showChars: 500
    });

  },

  initListFilters: function() {
    $('#apply-message-filters').on('click', function() {
      var targetRole = $('#target_role').val();
      var subjectId = $('#subject_id').val();
      var subSubjectId = $('#sub_subject_id').val();
      var startDate = $('#start_date').val();
      var endDate = $('#end_date').val();
      var valid = true;

      if (targetRole.length < 1 ) {
        alert(window._trans['required_filter_role']);
        valid = false;
      }

      if (subjectId != undefined && subjectId.length < 1) {
      alert(window._trans['required_filter_subject']);
        valid = false;
      }

      if (subSubjectId != undefined && subSubjectId.length < 1) {
        alert(window._trans['required_filter_sub_subject']);
        valid = false;
      }

      if (valid) {
        $.ajax({
          url: "#{list_messages_path(role: current_user.role, list_type: params['list_type'])}",
          type: 'GET',
          data: {
          target_role: targetRole,
            subject_id: subjectId,
            sub_subject_id: subSubjectId,
            start_date: startDate,
            end_date: endDate
          },
          success: function(data) {
            $('.message-list').html(data);
            window.location.href = '#';
          }
        });
      }
    });
  },

  initRoleSelector: function() {
    $('#target_role').on('change', function() {
      var targetRole = $(this).val();

      if (targetRole.length > 0) {
        $('#subject-filter').removeClass('hidden');
        $('#sub-subject-filter').removeClass('hidden');
      }
    });
  },

  initSubjectSelector: function() {
    $('select#subject_id').on('change', function() {
      var subjectId = $(this).val();

      $.ajax({
        url: '/messages/sub_subjects',
        data: {subject_id: subjectId},
        success: function(html) {
          $('#sub-subject-filter').html(html);
        }
      })
    });
  },

  initPrinter: function() {
    $('body').on('click', '.print-btn', function() {
      var data = $(this).data();
      var target = data.target_message;
      var subject = data.subject;
      var subSubject = data.sub_subject;
      var header = '';

      if (subject.length > 0) {
        header = 'Subject : ' + subject + '</br>';
        header += 'Sub-subject : ' + subSubject;
      }

      $(target).printThis({
        header: header,
        pageTitle: 'Healthier Childcare Alliance',
        importCSS: false,
        importStyle: false,
        formValues: false,
        printContainer: false
      });
    });
  },

  initNewMessage: function() {
    $.material.init();

    $('#message_content').froalaEditor({
      heightMin: 250
    });
  },

  initNewMessageTemplate: function() {
    this.initTemplateParser();

    $('#message_template_content').froalaEditor({
      heightMin: 200
    });
  },

  initTemplateParser: function() {
    // readable files : [*.html, *.txt]
    $('#upload-template').on('change', function() {
      var file = this.files[0]
      var reader = new FileReader();

      if (file.type.match('text.*')) {
        reader.onload = function(progressEvent){
          $('#message_template_content').val(this.result)
          $('#message_template_content').froalaEditor('html.set', this.result);
        };
        reader.readAsText(file);
      }
      else {
        alert(window._trans['invalid_template_file']);
      }
    });
  },

  initEditFilters: function() {
    $.material.init();
    this.initSubjectSelector();
  },

  initEditTemplate: function() {
    $('#message_template_content').froalaEditor({
      heightMin: 200
    });
  },

  initNewMessage: function() {
    $('#message_content').froalaEditor({
      heightMin: 250
    });
  }

}

$(document).ready(function() {

  $.material.init();

  $(".select").dropdown({ "autoinit" : ".select" });

});
