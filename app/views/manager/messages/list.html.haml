= content_for :title, 'Message List'

.row
  .page-header
    %h3 Filter option to see your messages :

.container-fluid.message-filters
  - if params['list_type'] == 'sent'
    = render 'sent_message_filters'
  - else
    = render 'received_message_filters'

.row.message-list
  - if @notification
    = render @notification.source

  = render '/messages/message_list'

:javascript
  $(function() {
    $('#start_date').datetimepicker({
      format: 'd/m/Y',
      timepicker: false
    });
  });

  $(function() {
    $('#end_date').datetimepicker({
      format: 'd/m/Y',
      timepicker: false
    });
  });

  $('#apply-message-filters').on('click', function() {
    var targetRole = $('#target_role').val();
    var subjectId = $('#subject_id').val();
    var subSubjectId = $('#sub_subject_id').val();
    var startDate = $('#start_date').val();
    var endDate = $('#end_date').val();
    var valid = true;

    if (targetRole.length < 1 ) {
      alert('Please choose filter Role');
      valid = false;
    }

    if (subjectId != undefined && subjectId.length < 1) {
      alert('Please choose subject');
      valid = false;
    }

    if (subSubjectId != undefined && subSubjectId.length < 1) {
      alert('Please choose sub-subject');
      valid = false;
    }

    if (valid) {
      $.ajax({
        url: '/manager/messages/#{params[:list_type]}/list',
        type: 'GET',
        data: {
          target_role: targetRole,
          subject_id: subjectId,
          sub_subject_id: subSubjectId,
          start_date: startDate,
          end_date: endDate
          },
        success: function(data) {
          $('.message-list').html(data);
          window.location.href = '#';
        }
      });
    }

  });

  $('#target_role').on('change', function() {
    var targetRole = $(this).val();
    console.log(targetRole);

    if (targetRole.length > 0) {
      $('#subject-filter').removeClass('hidden');
      $('#sub-subject-filter').removeClass('hidden');
    }

  });

  $('select#subject_id').on('change', function() {
    var subjectId = $(this).val();
    var subSubjects = $('#sub-subject-filter').find('select option[data-parent_id="' + subjectId + '"]');
    var subSubjectsValue = $.map(subSubjects, function(a) {return parseInt($(a).val())});

    var dropdownjsList = $('#sub-subject-filter').find('.dropdownjs ul li');

    $.each(dropdownjsList, function(idx, subSubjectLi) {
      li = $(subSubjectLi);

      if ($.inArray(li.val(), subSubjectsValue) > -1) {
        li.show();
      }
      else {
        li.hide();
      }
    });
  });
